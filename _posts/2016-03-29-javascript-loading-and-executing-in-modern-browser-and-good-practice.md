---
layout: post
title: 模块化工程前夜——JavaScript在浏览器的加载执行、库与实践
---

讨论这个的前件：在前端工程化的子话题：模块化中，模块化架构对模块管理、请求合并、按需加载几个子问题有着非常重要的意义。在此前，我们需要了解

两个疑问：

* 如何做到并行下载顺序执行？
* 如何保证一段js代码依赖的所有文件在其执行前都被执行完毕？（呃……不就是顺序执行的问题嘛。有个前提是需要程序员自己去指定加载顺序，能否由框架自动去处理这个事情呢？）
* 若有多个脚本，只有其中一部分被声明为`async`，此时会触发document的渲染吗？看了一下，并不会，但有些操作DOM的代码却可以工作了，是不是暗示着，async的脚本会在DOM加载完再被执行

## JavaScript代码的声明方式

主要有两种：

* `<script>`标签中直接写入
* 通过`<script>`标签引入外部文件

## 浏览器端JavaScript代码的声明周期

JavaScript代码在浏览器端的执行一般要经历三个阶段：加载、执行、等待事件，其中前两个阶段在 [JavaScript权威指南（第6版）](link)中被统称脚本执行阶段、后面一个阶段统称事件处理阶段。

加载和执行是顺序同步阻塞的。简单来说，一般情况下，解析引擎会去先解析（或下载）脚本，解析完毕以后马上执行。只有执行完一段脚本后，才能开始对下一段脚本的解析和执行，这个过程是按照脚本之间定义的顺序串行执行的。

# 浏览器端js与DOM的互动

**在这个过程中，HTML的文档渲染是被阻塞的**。因为解析引擎不知道正在执行的JavaScript代码是否会改变操作DOM树，删除某些标签等，因此它不会尝试提前加载资源(css/img)等。

当然，“HTML的文档渲染被阻塞”仅仅意味着它在浏览器中不会被显示出来，而未暗示此时DOM树的加载情况（是尚未解析、还是已解析完存在于内存中，仅仅是还未被浏览器渲染）。

又当然，以上均是规范情况，浏览器通常会采取各自的优化形式。比如我在chrome上试了下，脚本都是同时开始下载的。

## `defer`和`async`

鉴于